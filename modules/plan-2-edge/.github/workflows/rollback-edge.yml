name: Rollback Edge Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

permissions:
  contents: read
  deployments: write
  issues: write

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Get latest successful deployment
        id: get-deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: '${{ github.event.inputs.environment }}',
              per_page: 10
            });
            
            // Find the second most recent successful deployment
            const successfulDeployments = [];
            for (const deployment of deployments.data) {
              const statuses = await github.rest.repos.listDeploymentStatuses({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id
              });
              
              if (statuses.data[0]?.state === 'success') {
                successfulDeployments.push(deployment);
              }
              
              if (successfulDeployments.length >= 2) break;
            }
            
            if (successfulDeployments.length < 2) {
              throw new Error('No previous successful deployment found for rollback');
            }
            
            const targetDeployment = successfulDeployments[1];
            console.log(`Rolling back to deployment ${targetDeployment.id} (${targetDeployment.sha})`);
            
            return {
              deployment_id: targetDeployment.id,
              sha: targetDeployment.sha
            };

      - uses: actions/checkout@v4
        with:
          ref: ${{ fromJSON(steps.get-deployment.outputs.result).sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build workers
        run: |
          cd modules/plan-2-edge
          npm ci
          npm run build

      - name: Deploy previous version
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd modules/plan-2-edge
          npx wrangler deploy \
            --env ${{ github.event.inputs.environment }} \
            --compatibility-date $(date -d '1 month ago' +%Y-%m-%d)

      - name: Run health check
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            API_URL="https://api.twist.io"
          else
            API_URL="https://api-staging.twist.io"
          fi
          
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf "$API_URL/health" > /dev/null; then
              echo "Health check passed"
              break
            fi
            
            echo "Attempt $((attempt + 1))/$max_attempts failed, retrying..."
            sleep 5
            attempt=$((attempt + 1))
          done

      - name: Update deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: '${{ fromJSON(steps.get-deployment.outputs.result).sha }}',
              environment: '${{ github.event.inputs.environment }}',
              description: 'Rollback deployment',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: '${{ job.status }}',
              description: 'Rollback ${{ job.status }}'
            });

      - name: Create incident report
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Rollback: ${context.payload.inputs.environment} environment`,
              body: `## Rollback Report
              
              **Environment:** ${{ github.event.inputs.environment }}
              **Reason:** ${{ github.event.inputs.reason }}
              **Rolled back to:** ${{ fromJSON(steps.get-deployment.outputs.result).sha }}
              **Initiated by:** @${{ github.actor }}
              **Time:** ${new Date().toISOString()}
              
              ### Next Steps
              - [ ] Investigate root cause
              - [ ] Fix the issue
              - [ ] Test fix in staging
              - [ ] Re-deploy to production
              
              cc @twist-protocol/infrastructure`,
              labels: ['incident', 'rollback', context.payload.inputs.environment]
            });
            
            console.log(`Created incident report: ${issue.data.html_url}`);

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸ”„ Edge Infrastructure Rollback
            Environment: ${{ github.event.inputs.environment }}
            Reason: ${{ github.event.inputs.reason }}
            Status: ${{ job.status }}
            Initiated by: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}