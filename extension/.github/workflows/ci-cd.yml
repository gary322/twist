name: TWIST Extension CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [created]

env:
  NODE_VERSION: '18.x'
  EXTENSION_NAME: 'twist-extension'

jobs:
  # Linting and Type Checking
  lint-and-type-check:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Run TypeScript type checking
        run: npm run type-check
      
      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate

  # Unit and Integration Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    strategy:
      matrix:
        test-suite: [unit, integration, security, performance]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ${{ matrix.test-suite }} tests
        run: npm run test:${{ matrix.test-suite }}
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: ${{ matrix.test-suite }}
          name: ${{ matrix.test-suite }}-coverage

  # Build Extension for All Browsers
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        browser: [chrome, firefox, edge, safari]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for ${{ matrix.browser }}
        run: npm run build:${{ matrix.browser }}
      
      - name: Validate manifest
        run: |
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            npx addons-linter dist/${{ matrix.browser }}/
          fi
      
      - name: Create artifact
        run: |
          cd dist/${{ matrix.browser }}
          zip -r ../../${{ env.EXTENSION_NAME }}-${{ matrix.browser }}-${{ github.sha }}.zip .
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.EXTENSION_NAME }}-${{ matrix.browser }}
          path: ${{ env.EXTENSION_NAME }}-${{ matrix.browser }}-${{ github.sha }}.zip
          retention-days: 30

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      
      - name: Upload Snyk results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: snyk.sarif

  # Performance Testing
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download Chrome artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.EXTENSION_NAME }}-chrome
      
      - name: Run performance benchmarks
        run: |
          unzip ${{ env.EXTENSION_NAME }}-chrome-${{ github.sha }}.zip -d test-extension
          npm run test:performance:ci -- --extension-path=test-extension
      
      - name: Upload performance results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: performance-results.json

  # Deploy to Test Environment
  deploy-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [security-scan, performance-test]
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v3
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Deploy to test stores
        run: |
          # Deploy to Chrome Web Store (test)
          npm run deploy:chrome:test -- \
            --extension-id=${{ secrets.CHROME_TEST_EXTENSION_ID }} \
            --client-id=${{ secrets.CHROME_CLIENT_ID }} \
            --client-secret=${{ secrets.CHROME_CLIENT_SECRET }} \
            --refresh-token=${{ secrets.CHROME_REFRESH_TOKEN }} \
            --file=artifacts/${{ env.EXTENSION_NAME }}-chrome/${{ env.EXTENSION_NAME }}-chrome-${{ github.sha }}.zip
      
      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Test deployment completed for commit ${{ github.sha }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [security-scan, performance-test]
    if: github.event_name == 'release'
    environment: production
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Deploy to Chrome Web Store
        run: |
          npm run deploy:chrome:prod -- \
            --extension-id=${{ secrets.CHROME_EXTENSION_ID }} \
            --client-id=${{ secrets.CHROME_CLIENT_ID }} \
            --client-secret=${{ secrets.CHROME_CLIENT_SECRET }} \
            --refresh-token=${{ secrets.CHROME_REFRESH_TOKEN }} \
            --file=artifacts/${{ env.EXTENSION_NAME }}-chrome/${{ env.EXTENSION_NAME }}-chrome-${{ github.sha }}.zip
      
      - name: Deploy to Firefox Add-ons
        run: |
          npm run deploy:firefox:prod -- \
            --api-key=${{ secrets.FIREFOX_API_KEY }} \
            --api-secret=${{ secrets.FIREFOX_API_SECRET }} \
            --addon-id=${{ secrets.FIREFOX_ADDON_ID }} \
            --file=artifacts/${{ env.EXTENSION_NAME }}-firefox/${{ env.EXTENSION_NAME }}-firefox-${{ github.sha }}.zip
      
      - name: Deploy to Edge Add-ons
        run: |
          npm run deploy:edge:prod -- \
            --product-id=${{ secrets.EDGE_PRODUCT_ID }} \
            --client-id=${{ secrets.EDGE_CLIENT_ID }} \
            --client-secret=${{ secrets.EDGE_CLIENT_SECRET }} \
            --access-token-url=${{ secrets.EDGE_ACCESS_TOKEN_URL }} \
            --file=artifacts/${{ env.EXTENSION_NAME }}-edge/${{ env.EXTENSION_NAME }}-edge-${{ github.sha }}.zip
      
      - name: Create GitHub Release Assets
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            artifacts/${{ env.EXTENSION_NAME }}-chrome/${{ env.EXTENSION_NAME }}-chrome-${{ github.sha }}.zip \
            artifacts/${{ env.EXTENSION_NAME }}-firefox/${{ env.EXTENSION_NAME }}-firefox-${{ github.sha }}.zip \
            artifacts/${{ env.EXTENSION_NAME }}-edge/${{ env.EXTENSION_NAME }}-edge-${{ github.sha }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update version in stores
        run: |
          echo "Extension version ${{ github.event.release.tag_name }} deployed to all stores"
      
      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production deployment completed for version ${{ github.event.release.tag_name }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Post-deployment Monitoring
  post-deploy-check:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v3
      
      - name: Wait for stores to update
        run: sleep 300 # Wait 5 minutes
      
      - name: Verify Chrome Web Store
        run: |
          npm run verify:chrome -- \
            --extension-id=${{ secrets.CHROME_EXTENSION_ID }} \
            --expected-version=${{ github.event.release.tag_name }}
      
      - name: Verify Firefox Add-ons
        run: |
          npm run verify:firefox -- \
            --addon-id=${{ secrets.FIREFOX_ADDON_ID }} \
            --expected-version=${{ github.event.release.tag_name }}
      
      - name: Run smoke tests
        run: npm run test:smoke
      
      - name: Check error monitoring
        run: |
          npm run check:sentry -- \
            --project=${{ secrets.SENTRY_PROJECT }} \
            --auth-token=${{ secrets.SENTRY_AUTH_TOKEN }}